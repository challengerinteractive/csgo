version: 2
jobs:
  build_gameserver:
    working_directory: ~/csgo
    docker:
      - image: docker:17.11.0-ce-git
    steps:
      - checkout
      - setup_remote_docker:
          version: 17.11.0-ce
      - run:
          name: install AWS Cli
          command: |
            apk -Uuv add groff less python py-pip
            pip install awscli
      - run:
          name: Build cs:go game image
          command: |
            cd gameserver
            docker build -t 367860534964.dkr.ecr.us-west-2.amazonaws.com/challenger/csgo:${CIRCLE_SHA1} .
      - run:
          name: tag and push csgo game server image
          command: |
            $(aws ecr get-login --no-include-email)
            docker tag 367860534964.dkr.ecr.us-west-2.amazonaws.com/challenger/csgo:${CIRCLE_SHA1} 367860534964.dkr.ecr.us-west-2.amazonaws.com/challenger/csgo:latest
            docker push 367860534964.dkr.ecr.us-west-2.amazonaws.com/challenger/csgo
  build_eventforwarder:
    working_directory: ~/csgo
    docker:
      - image: docker:17.11.0-ce-git
    steps:
      - checkout
      - setup_remote_docker:
          version: 17.11.0-ce
      - run:
          name: install AWS Cli
          command: |
            apk -Uuv add groff less python py-pip
            pip install awscli
      - run:
          name: Build Event forwarder Docker image
          command: |
            cd event_forwarder
            docker build -t 367860534964.dkr.ecr.us-west-2.amazonaws.com/challenger/csgo_event_forwarder:${CIRCLE_SHA1} .
      - run:
          name: tag and push event forwarder Docker image
          command: |
            $(aws ecr get-login --no-include-email)
            docker tag 367860534964.dkr.ecr.us-west-2.amazonaws.com/challenger/csgo_event_forwarder:${CIRCLE_SHA1} 367860534964.dkr.ecr.us-west-2.amazonaws.com/challenger/csgo_event_forwarder:latest
            docker push 367860534964.dkr.ecr.us-west-2.amazonaws.com/challenger/csgo_event_forwarder
  publish_tag:
    working_directory: ~/csgo
    docker:
      - image: docker:17.11.0-ce-git
    steps:
      - checkout
      - setup_remote_docker:
          version: 17.11.0-ce
      - run:
          name: install AWS Cli
          command: |
            apk -Uuv add groff less python py-pip
            pip install awscli
      - run:
          name: pull, re-tag and push images
          command: |
            $(aws ecr get-login --no-include-email)
            docker pull 367860534964.dkr.ecr.us-west-2.amazonaws.com/challenger/csgo_event_forwarder:${CIRCLE_SHA1} &
            docker pull 367860534964.dkr.ecr.us-west-2.amazonaws.com/challenger/csgo:${CIRCLE_SHA1} &
            echo "Waiting for pulls to complete"
            wait
            docker tag 367860534964.dkr.ecr.us-west-2.amazonaws.com/challenger/csgo_event_forwarder:${CIRCLE_SHA1} 367860534964.dkr.ecr.us-west-2.amazonaws.com/challenger/csgo_event_forwarder:${CIRCLE_TAG} &
            docker tag 367860534964.dkr.ecr.us-west-2.amazonaws.com/challenger/csgo:${CIRCLE_SHA1} 367860534964.dkr.ecr.us-west-2.amazonaws.com/challenger/csgo:${CIRCLE_TAG} &
            echo "Waiting for tags to complete"
            wait
            docker push 367860534964.dkr.ecr.us-west-2.amazonaws.com/challenger/csgo_event_forwarder:${CIRCLE_TAG} &
            docker push 367860534964.dkr.ecr.us-west-2.amazonaws.com/challenger/csgo:${CIRCLE_TAG} &
            echo "Waiting for pushes to complete"
            wait
            echo "Re-tag complete..."
workflows:
  version: 2
  build_and_publish:
    jobs:
      - build_gameserver:
          context: challenger_aws_prod
          filters:
            tags:
              ignore: /^v.*/
      - build_eventforwarder:
          context: challenger_aws_prod
          filters:
            tags:
              ignore: /^v.*/
      - publish_tag:
          context: challenger_aws_prod
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^v.*/
